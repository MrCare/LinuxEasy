# 权限管理

## 1. ACL权限

Access Control List

临时用户的权限

- windows中 文件 -> 属性 -> 安全 -> 不再考虑身份，直接给权限

- 需要查看分区 ACL 权限是否开启

几个命令

- `dumpe2fs -h /dev/sda3`    #查看分区使用状况与占有磁盘容量
  
  - Default mount options：user_xattr acl    #acl已经开启，但是默认一般都支持

- `df -h`    #查看分区使用状况与占有磁盘容量的

- `mount -o remount,acl/`    #重新挂载根分区，并挂载加入acl权限

- 永久修改需修改配置文件，再重启系统

### 查看与设定ACL权限

`getfacl` + 文件名    #查看 ACL 权限

`setfacl` + 选项 + 文件名

| 选项   | 作用          |
| ---- | ----------- |
| `-m` | 设定 ACL 权限   |
| `-x` | 删除指定 ACL 权限 |
| `-b` | 删除所有 ACL 权限 |
| `-d` | 设定默认 ACL 权限 |
| `-k` | 删除默认 ACL 权限 |
| `-R` | 递归设定 ACL 权限 |

```bash
setfacl -m u:用户名:rwx    #给某一用户设置权限
setfacl -m g:组:rwx    #给某一组设置权限
```

### 最大有效权限与删除ACL权限

最大有效权限 mask

- 是用来指定最大有效权限的，如果给用户赋予了ACL权限，需要和用户相与才能得到真正的权限

- `setfacl -m m:rx file.txt`    #设置文件的 mask 权限

```bash
-rw-rwxr--+ 1 root root 0 6月  26 08:52 /tmp/file.txt    #"+"是ACL权限的标志
```

默认ACL权限

- 作用是如果给父目录设定了默认ACL权限，那么父目录中所有新建的子文件都会继承父目录的ACL权限
  
  - `setfacl -md u:用户名:rwx 目录`

递归ACL权限

- 递归是父目录在设定ACL权限时，所有子文件和子目录也对拥有相同的ACL权限（对新添加文件无效）
  
  - `setfacl -m u:用户名：权限 -R 文件名(目录)`

## 2. 文件特殊权限

### SetUID

setUID的功能：

- 只有可以执行的二进制程序才能设定SUID权限

- 命令执行者要对该程序拥有 x 权限

- 命令执行者在执行该程序时获得该程序文件属主的身份(在执行过程中灵魂附体为文件属主)

- SetUID权限只在该程序执行过程中有效

eg：

- `passwd` 普通用户可以更改密码，但是对`/etc/shadow`文件却没有写入权限，这是如何做到的？

- `passwd` 拥有SerUID权限，所以普通用户可以修改自己的密码

```bash
ll /usr/bin/passwd


-rwsr-xr-x. 1 root root 30768 11月 24 2015 /usr/bin/passwd    #"s"代表SetUID权限
```

设定SetUID的方法

- 4代表SetUID
  
  - `chmod 4755` + 文件名
  
  - `chmod u+s file.txt` 

取消SerUID的方法

- `chmod 4755` + 文件名

- `chmod u-s` + 文件名

危险的SerUID

- 关键目录应严格控制写权限，比如`/`，`/usr` 等

- 用户的密码设置要严格遵守密码三原则

- 对系统中默认应该具有SerUID权限文件做一个list，定时检查有没有这之外的文件被设置为了SetUID权限(可以用shell编程实现)

### SetGID

SetGID 的作用：

- 只有可执行的二进制程序才能设置SGID权限

- 命令执行者要对该程序拥有 x 权限

- 命令执行在执行程序的时候，组身份升级为该程序文件的属组

- SetGID权限同样只在该程序执行过程中有效，也就是说组身份改变只在程序执行过程中有效

设定SetGID：

- 2代表SGID权限
  
  - `chmod 2755 file.txt`
  
  - `chmod g+s file.txt`

### Sticky BIT

SBIT 黏着位作用

- 黏着位目前只对目录有效

- 普通用户对该目录拥有w和x权限，即普通用户可以在此目录拥有写入权限

- 如果没有黏着位，因为普通用户拥有w权限，所以可以删除此目录下的所有文件，包括其他用户建立的文件，一旦赋予了黏着位权限，除了root用户可以删除所有文件，普通用户就算拥有w权限，也只能删除自己建立的文件，但是不能删除其他用户建立的文件

## 3. 文件系统属性 chattr 权限

- `chattr` + [+-=] + 选项 + 文件名or目录名
  
  - `+`：增加权限
  
  - `-`：删除权限
  
  - `=`：等于权限

| 选项   | 作用                                                                 |
| ---- | ------------------------------------------------------------------ |
| `-i` | 某文件被设置了`i`属性，不允许针对文件进行删除，改名，修改等，对root用户依然生效，若某目录有该属性，则只能修改文件，而不能删除 |

- `lsattr -a` + 文件名or目录名    #查看chattr权限的特殊方法

| 选项   | 作用                                                         |
| ---- | ---------------------------------------------------------- |
| `-a` | 某文件被设置成`a`属性，那么只能在文件中增加数据，不能修改也不能删除，某目录有a属性只能建立和修改文件，不允许删除 |

## 4. sudo权限

- 把本只能是root用户执行的命令赋予普通用户执行

- sudo对象是系统命令

sudo使用

- `visudo`     #实际上是修改 `/etc/sudoers` 文件，root开放权限

- `sudo` + 绝对路径    #不可赋予用户 vim/vi 命令
