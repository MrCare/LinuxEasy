# 日志管理

## 1. 日志管理简介

日志服务

- CentOS 6.x 中日志服务已经由rsyslogd取代了原先的syslogd服务，syslogd日志服务更加先进，功能更多，但是不论该服务的使用，还是日志文件的格式其实都是和syslogd服务相兼容的，所以学习起来基本和syslogd服务一致

- rsyslogd 的新特点：
  
  - 基于TCP网络协议传输日志信息
  
  - 更安全的网络传输方式
  
  - 有日志消息的及时分析框架
  
  - 后台数据库
  
  - 配置文件中可以写简单的逻辑判断
  
  - 与syslog配置文件兼容

确定服务启动

- `ps aus | grep rsyslogd`    #查看服务是否启动

- `chkconfig --list | grep rsyslog`    #查看服务是否自启动

常见日志的作用

| 日志文件               | 说明                                                                                   |
| ------------------ | ------------------------------------------------------------------------------------ |
| `/var/logcron`     | 记录了系统定时任务相关的日志                                                                       |
| `/var/log/cups`    | 记录打印信息的日志                                                                            |
| `/var/log/dmesg`   | 记录了系统在开机时内核自检的信息。也可使用dmesg命令直接查看内核自检信息                                               |
| `/var/log/btmp`    | 记录错误登录的日志，这个文件是二进制文件，不能用vim查看，需使用`lastb` 命令                                          |
| `/var/log/lastlog` | 记录系统中所有用户最后一次的登录时间的日志，这个文件也是二进制文件，不能vim查看，需用`lastlog`                                |
| `/var/log/message` | 记录系统重要信息的日志，这个日志文件中会记录Linux系统的绝大多数重要信息，如果系统出现了问题，首先要检查的应该是这个日志文件                     |
| `/var/log/secure`  | 记录验证和授权方面的信息，只要涉及账户和密码的文件都会记录，比如说系统的登录，ssh登录，su切换用户，sudo授权，甚至添加用户和修改用户密码都会记录在这个日志文件中 |
| `/var/log/wtmp`    | 永久记录所有用户的登录，注销信息，同时记录系统的启动，重启关机事件，同样这个文件也是一个二进制文件，需要用`last` 查看                       |
| `/var/run/utmp`    | 记录当前已经登录的用户的信息，这个文件会随着用户的登录和注销而不断变化，只记录当前的登录用户信息，同样这个文件不能直接vi，而要使用`w,who,users`等命令查询 |
| `/var/log//mailog` | 记录邮件信息                                                                               |

- 除了系统默认日志外，采用RPM方式安装的系统服务也会默认把日志记录在`/var/log`目录中（源码包安装的服务日志是在源码包指定的目录中），不过这些日志不是由rsyslogd服务来记录和管理的，而是各个服务使用自己的日志管理文档来记录自身日志（/user/local）

## 2. rsyslogd日志服务

日志文件格式

- 基本日志文件格式包含4列：
  
  - 事件产生时间
  
  - 发生事件的服务器的主机名
  
  - 发生事件的服务名或程序名
  
  - 事件的具体信息

`/etc/rsyslog.conf`配置文件

- `authpriv.*    /var/log/secure`
- 服务名称[连接符号]日志等级     日志记录位置

| 服务名称          | 说明                                                                   |
| ------------- | -------------------------------------------------------------------- |
| auth          | 安全和认证相关信息                                                            |
| authpriv      | 安全和认证相关消息（private）                                                   |
| cron          | 系统定时任务cront和at产生的日志                                                  |
| daemon        | 和各个守护进程相关的日志                                                         |
| ftp           | ftp守护进程产生的日志                                                         |
| kern          | 内核产生的日志（不是用户进程产生的）                                                   |
| local0-local7 | 为本地使用预留的服务                                                           |
| lpr           | 打印生产日期                                                               |
| mail          | 邮件收发信息                                                               |
| news          | 与新闻服务器相关的日志                                                          |
| syslog        | 有syslogd服务产生的日志信息（虽然服务名称已经改为了rsyslogd但是很多配置还是沿用了syslogd的，这里并没有修改服务名） |
| user          | 用户等级类别的日志信息                                                          |
| uucp          | uucp子系统的日志信息，uucp是早期linux系统进行数据传递的协议，后来也常用在新闻组服务中                    |

| 连接符号 | 作用                                                               |
| ---- | ---------------------------------------------------------------- |
| `*`  | 代表所有日志等级                                                         |
| `.`  | 代表只要后面的等级高的日志都记录下来，比如cron.info代表cron服务产生的日志，只要日志等级大于等于info级别，就记录 |
| `.=` | 代表只记录所需等级的日志，骐达等级都不记录                                            |
| `.!` | 表示除了该等级的都记录                                                      |

| 日志等级    | 说明                   |
| ------- | -------------------- |
| debug   | 一般的调试信息说明            |
| info    | 基本的通知信息              |
| notice  | 普通信息，但是有一定的重要性       |
| warning | 警告信息，但是还不会影响到服务或系统运行 |
| err     | 错误信息                 |
| crit    | 临界状况信息，严重于err        |
| alert   | 警告状态信息，严重于alert      |
| emerg   | 系统已经无法使用             |

日志记录位置

- 日志文件的绝对路径，如`/var/log/secure`

- 系统设备文件，如`/dev/lp0`

- 转发给远程主机，如`@19.232.55.114``

- 用户名，如`root`

- 忽略或丢弃日志，如`~`

## 3. 日志轮替

日志文件的命名规则

- 如果配置文件中拥有"dateext"参数，那么日志会用日期来作为日志文件的后缀，例如“secure-20190504”，这样的话日志文件名不会重叠，所以也就不需要日志文件的改名，只需要保存制定的日志个数，删除多余的日志文件即可

- 如果配置文件中没有“dateext”参数，那么日志文件就需要进行改名了，当第一次进行日志轮替时，当前的“secure”日志会自动更名为“secure.1”，然后新建“secure”日志，用来保存新的日志，以此类推

logrotate 配置文件

- `/etc/logrotate.conf`

| 参数                       | 参数说明                     |
| ------------------------ | ------------------------ |
| daily                    | 日志的轮替周期是每天               |
| weekly                   | 日志的轮替周期是没周               |
| monthly                  | 每月                       |
| rotate + 数字              | 保留的日志文件的个数，0指没有备份        |
| compress                 | 日志轮替时，旧的日志进行压缩           |
| create  + 权限 + 所有者 + 所属组 | 建立新日志，同时制定新日志的权限与所有者和所属组 |
| mail + 邮件地址              | 日志轮替时，输出内容通过邮件发送到制定的邮件地址 |
| missingok                | 如果日志不存在，忽略日志的警告信息        |
| notifempty               | 如果日志为空文件，不进行日志轮替         |
| minsize + 大小             | 按照时间轮替，担需要大于设置的值         |
| size + 大小                | 日志只有大于制定大小才进行轮替，而不是按照时间  |
| dateext                  | 使用日期作为文件的后缀              |

把apache日志加入轮替

- RPM包安装的日志默认都会做轮替

- 源码包安装日志才需要手工做轮替

```bash
vi /etc/logrotate.conf
/usr/local/apache2/logs/access_log{
    daily    #每天备份
    create    #备份时创建新的
    rotate 30    #保留30天的日志
}
```

logrotate 命令

- `logrotate` +选项 + 配置文件名
  
  - 如果没有选项，则会按照配置文件中的条件进行日志轮替

| 选项   | 作用                       |
| ---- | ------------------------ |
| `-v` | 显示日志轮替过程。加此选项会显示日志的轮替过程  |
| `-f` | 强制轮替，不管日志轮替的条件是否已经符合都会轮替 |

日志轮替的意义：

- 切割

- 删旧留新












